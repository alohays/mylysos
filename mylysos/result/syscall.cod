; Listing generated by Microsoft (R) Optimizing Compiler Version 14.00.50727.42 

	TITLE	c:\Users\상우\Documents\카카오톡 받은 파일\MylysOS\syscall.c
	.686P
	.XMM
	include listing.inc
	.model	flat

INCLUDELIB MSVCRTD
INCLUDELIB OLDNAMES

_BSS	SEGMENT
?result@?1??Sysp_SERVICE_CALL_MANAGER@@9@9 DD 01H DUP (?) ; `Sysp_SERVICE_CALL_MANAGER'::`2'::result
_BSS	ENDS
PUBLIC	??_C@_0CL@BMDCEDJF@SysSetupSysCallgate?$CI?$CJ?5returned?5a@ ; `string'
PUBLIC	_SysInitializeSyscall
EXTRN	_MmAllocateNonCachedMemory:PROC
EXTRN	_CrtPrintf:PROC
_BSS	SEGMENT
_m_pSyscallStack DD 01H DUP (?)
_BSS	ENDS
;	COMDAT ??_C@_0CL@BMDCEDJF@SysSetupSysCallgate?$CI?$CJ?5returned?5a@
; File c:\users\상우\documents\카카오톡 받은 파일\mylysos\syscall.c
CONST	SEGMENT
??_C@_0CL@BMDCEDJF@SysSetupSysCallgate?$CI?$CJ?5returned?5a@ DB 'SysSetup'
	DB	'SysCallgate() returned an error.', 0dH, 0aH, 00H ; `string'
; Function compile flags: /Odtp /ZI
CONST	ENDS
;	COMDAT _SysInitializeSyscall
_TEXT	SEGMENT
_SysInitializeSyscall PROC				; COMDAT

; 14   : {

  00000	55		 push	 ebp
  00001	8b ec		 mov	 ebp, esp
  00003	83 ec 40	 sub	 esp, 64			; 00000040H
  00006	53		 push	 ebx
  00007	56		 push	 esi
  00008	57		 push	 edi

; 15   : 	if(!SyspSetupSysCallgate()) {

  00009	e8 00 00 00 00	 call	 _SyspSetupSysCallgate
  0000e	85 c0		 test	 eax, eax
  00010	75 11		 jne	 SHORT $LN2@SysInitial

; 16   : 		DbgPrint("SysSetupSysCallgate() returned an error.\r\n");

  00012	68 00 00 00 00	 push	 OFFSET ??_C@_0CL@BMDCEDJF@SysSetupSysCallgate?$CI?$CJ?5returned?5a@
  00017	e8 00 00 00 00	 call	 _CrtPrintf
  0001c	83 c4 04	 add	 esp, 4

; 17   : 		return FALSE;

  0001f	33 c0		 xor	 eax, eax
  00021	eb 24		 jmp	 SHORT $LN3@SysInitial
$LN2@SysInitial:

; 18   : 	}
; 19   : 
; 20   : 	//시스템 콜 호출시에 커널 영역에서 사용될 스택을 설정
; 21   : 	m_pSyscallStack = MmAllocateNonCachedMemory(DEFAULT_STACK_SIZE);

  00023	68 00 00 01 00	 push	 65536			; 00010000H
  00028	e8 00 00 00 00	 call	 _MmAllocateNonCachedMemory
  0002d	83 c4 04	 add	 esp, 4
  00030	a3 00 00 00 00	 mov	 DWORD PTR _m_pSyscallStack, eax

; 22   : 	if(m_pSyscallStack == NULL) return FALSE;

  00035	83 3d 00 00 00
	00 00		 cmp	 DWORD PTR _m_pSyscallStack, 0
  0003c	75 04		 jne	 SHORT $LN1@SysInitial
  0003e	33 c0		 xor	 eax, eax
  00040	eb 05		 jmp	 SHORT $LN3@SysInitial
$LN1@SysInitial:

; 23   : 
; 24   : 	return TRUE;

  00042	b8 01 00 00 00	 mov	 eax, 1
$LN3@SysInitial:

; 25   : }

  00047	5f		 pop	 edi
  00048	5e		 pop	 esi
  00049	5b		 pop	 ebx
  0004a	8b e5		 mov	 esp, ebp
  0004c	5d		 pop	 ebp
  0004d	c3		 ret	 0
_SysInitializeSyscall ENDP
_TEXT	ENDS
PUBLIC	_SysGetSyscallStackPtr
; Function compile flags: /Odtp /ZI
;	COMDAT _SysGetSyscallStackPtr
_TEXT	SEGMENT
_SysGetSyscallStackPtr PROC				; COMDAT

; 28   : {

  00000	55		 push	 ebp
  00001	8b ec		 mov	 ebp, esp
  00003	83 ec 40	 sub	 esp, 64			; 00000040H
  00006	53		 push	 ebx
  00007	56		 push	 esi
  00008	57		 push	 edi

; 29   : 	return (VOID *)m_pSyscallStack;

  00009	a1 00 00 00 00	 mov	 eax, DWORD PTR _m_pSyscallStack

; 30   : }

  0000e	5f		 pop	 edi
  0000f	5e		 pop	 esi
  00010	5b		 pop	 ebx
  00011	8b e5		 mov	 esp, ebp
  00013	5d		 pop	 ebp
  00014	c3		 ret	 0
_SysGetSyscallStackPtr ENDP
_TEXT	ENDS
PUBLIC	_SysGetSyscallStackSize
; Function compile flags: /Odtp /ZI
;	COMDAT _SysGetSyscallStackSize
_TEXT	SEGMENT
_SysGetSyscallStackSize PROC				; COMDAT

; 33   : {

  00000	55		 push	 ebp
  00001	8b ec		 mov	 ebp, esp
  00003	83 ec 40	 sub	 esp, 64			; 00000040H
  00006	53		 push	 ebx
  00007	56		 push	 esi
  00008	57		 push	 edi

; 34   : 	return DEFAULT_STACK_SIZE;

  00009	b8 00 00 01 00	 mov	 eax, 65536		; 00010000H

; 35   : }

  0000e	5f		 pop	 edi
  0000f	5e		 pop	 esi
  00010	5b		 pop	 ebx
  00011	8b e5		 mov	 esp, ebp
  00013	5d		 pop	 ebp
  00014	c3		 ret	 0
_SysGetSyscallStackSize ENDP
_TEXT	ENDS
EXTRN	_m_GdtTable:BYTE
; Function compile flags: /Odtp /ZI
;	COMDAT _SyspSetupSysCallgate
_TEXT	SEGMENT
_SyspSetupSysCallgate PROC				; COMDAT

; 78   : {

  00000	55		 push	 ebp
  00001	8b ec		 mov	 ebp, esp
  00003	83 ec 40	 sub	 esp, 64			; 00000040H
  00006	53		 push	 ebx
  00007	56		 push	 esi
  00008	57		 push	 edi

; 79   : ENTER_CRITICAL_SECTION();

  00009	9c		 pushfd
  0000a	fa		 cli

; 80   : 	m_GdtTable[SYSCALL_GATE>>3].count		= 1;

  0000b	c6 05 4c 00 00
	00 01		 mov	 BYTE PTR _m_GdtTable+76, 1

; 81   : 	m_GdtTable[SYSCALL_GATE>>3].type		= 0xec;

  00012	c6 05 4d 00 00
	00 ec		 mov	 BYTE PTR _m_GdtTable+77, 236 ; 000000ecH

; 82   : 	m_GdtTable[SYSCALL_GATE>>3].selector	= KERNEL_CS;

  00019	66 c7 05 4a 00
	00 00 08 00	 mov	 WORD PTR _m_GdtTable+74, 8

; 83   : 	
; 84   : 	m_GdtTable[SYSCALL_GATE>>3].offset_1	= (BYTE) (((int)Sysp_SERVICE_CALL_MANAGER) & 0x000000ff);

  00022	b8 00 00 00 00	 mov	 eax, OFFSET _Sysp_SERVICE_CALL_MANAGER
  00027	25 ff 00 00 00	 and	 eax, 255		; 000000ffH
  0002c	a2 48 00 00 00	 mov	 BYTE PTR _m_GdtTable+72, al

; 85   : 	m_GdtTable[SYSCALL_GATE>>3].offset_2	= (BYTE)((((int)Sysp_SERVICE_CALL_MANAGER) & 0x0000ff00) >> 8);

  00031	b8 00 00 00 00	 mov	 eax, OFFSET _Sysp_SERVICE_CALL_MANAGER
  00036	25 00 ff 00 00	 and	 eax, 65280		; 0000ff00H
  0003b	c1 f8 08	 sar	 eax, 8
  0003e	a2 49 00 00 00	 mov	 BYTE PTR _m_GdtTable+73, al

; 86   : 	m_GdtTable[SYSCALL_GATE>>3].offset_3	= (BYTE)((((int)Sysp_SERVICE_CALL_MANAGER) & 0x00ff0000) >> 16);

  00043	b8 00 00 00 00	 mov	 eax, OFFSET _Sysp_SERVICE_CALL_MANAGER
  00048	25 00 00 ff 00	 and	 eax, 16711680		; 00ff0000H
  0004d	c1 f8 10	 sar	 eax, 16			; 00000010H
  00050	a2 4e 00 00 00	 mov	 BYTE PTR _m_GdtTable+78, al

; 87   : 	m_GdtTable[SYSCALL_GATE>>3].offset_4	= (BYTE)((((int)Sysp_SERVICE_CALL_MANAGER) & 0xff000000) >> 24);

  00055	b8 00 00 00 00	 mov	 eax, OFFSET _Sysp_SERVICE_CALL_MANAGER
  0005a	25 00 00 00 ff	 and	 eax, -16777216		; ff000000H
  0005f	c1 e8 18	 shr	 eax, 24			; 00000018H
  00062	a2 4f 00 00 00	 mov	 BYTE PTR _m_GdtTable+79, al

; 88   : EXIT_CRITICAL_SECTION();

  00067	9d		 popfd

; 89   : 
; 90   : 	return TRUE;

  00068	b8 01 00 00 00	 mov	 eax, 1

; 91   : }

  0006d	5f		 pop	 edi
  0006e	5e		 pop	 esi
  0006f	5b		 pop	 ebx
  00070	8b e5		 mov	 esp, ebp
  00072	5d		 pop	 ebp
  00073	c3		 ret	 0
_SyspSetupSysCallgate ENDP
_TEXT	ENDS
EXTRN	_CrtPrintText:PROC
EXTRN	_HalTaskSwitch:PROC
EXTRN	_PsSetThreadStatus:PROC
EXTRN	_PsGetCurrentThread:PROC
_BSS	SEGMENT
?call_msg@?1??Sysp_SERVICE_CALL_MANAGER@@9@9 DD 01H DUP (?) ; `Sysp_SERVICE_CALL_MANAGER'::`2'::call_msg
; Function compile flags: /Odtp /ZI
_BSS	ENDS
;	COMDAT _Sysp_SERVICE_CALL_MANAGER
_TEXT	SEGMENT
tv64 = -68						; size = 4
_Sysp_SERVICE_CALL_MANAGER PROC				; COMDAT

; 41   : 	static PSYSCALL_MSG call_msg;
; 42   : 	static KBD_KEY_DATA key_data;
; 43   : 	static int result=0;
; 44   : 
; 45   : 	_asm {
; 46   : 		mov		eax, [esp+8]

  00000	8b 44 24 08	 mov	 eax, DWORD PTR [esp+8]

; 47   : 		mov		call_msg, eax

  00004	a3 00 00 00 00	 mov	 DWORD PTR ?call_msg@?1??Sysp_SERVICE_CALL_MANAGER@@9@9, eax

; 48   : 
; 49   : 		pushad

  00009	60		 pushad

; 50   : 	}
; 51   : 
; 52   : 	switch(call_msg->syscall_type) {

  0000a	a1 00 00 00 00	 mov	 eax, DWORD PTR ?call_msg@?1??Sysp_SERVICE_CALL_MANAGER@@9@9
  0000f	8b 08		 mov	 ecx, DWORD PTR [eax]
  00011	89 4d bc	 mov	 DWORD PTR tv64[ebp], ecx
  00014	83 7d bc 00	 cmp	 DWORD PTR tv64[ebp], 0
  00018	74 08		 je	 SHORT $LN3@Sysp_SERVI
  0001a	83 7d bc 06	 cmp	 DWORD PTR tv64[ebp], 6
  0001e	74 19		 je	 SHORT $LN2@Sysp_SERVI
  00020	eb 28		 jmp	 SHORT $LN4@Sysp_SERVI
$LN3@Sysp_SERVI:

; 53   : 
; 54   : 		//시스템 api : 응용프로그램 종료되었을 때 처리
; 55   : 		case SYSCALL_TERMINATED:
; 56   : 			PsSetThreadStatus(PsGetCurrentThread(), THREAD_STATUS_TERMINATED);

  00022	6a 01		 push	 1
  00024	e8 00 00 00 00	 call	 _PsGetCurrentThread
  00029	50		 push	 eax
  0002a	e8 00 00 00 00	 call	 _PsSetThreadStatus
  0002f	83 c4 08	 add	 esp, 8

; 57   : 			HalTaskSwitch();

  00032	e8 00 00 00 00	 call	 _HalTaskSwitch

; 58   : 			break;

  00037	eb 11		 jmp	 SHORT $LN4@Sysp_SERVI
$LN2@Sysp_SERVI:

; 59   : 
; 60   : 			/// 스크린 api : 화면에 문자열을 출력하는 서비스
; 61   : 		case SYSCALL_PRINT_TEXT:
; 62   : 			CrtPrintText(call_msg->parameters.PRINT_TEXT.pt_text);

  00039	a1 00 00 00 00	 mov	 eax, DWORD PTR ?call_msg@?1??Sysp_SERVICE_CALL_MANAGER@@9@9
  0003e	8b 48 08	 mov	 ecx, DWORD PTR [eax+8]
  00041	51		 push	 ecx
  00042	e8 00 00 00 00	 call	 _CrtPrintText
  00047	83 c4 04	 add	 esp, 4
$LN4@Sysp_SERVI:

; 63   : 			break;
; 64   : 
; 65   : 		default:
; 66   : 			break;
; 67   : 	}
; 68   : 
; 69   : 	_asm {
; 70   : 		popad

  0004a	61		 popad

; 71   : 		mov			eax, result

  0004b	a1 00 00 00 00	 mov	 eax, DWORD PTR ?result@?1??Sysp_SERVICE_CALL_MANAGER@@9@9

; 72   : 		ret			4

  00050	c2 04 00	 ret	 4
_Sysp_SERVICE_CALL_MANAGER ENDP
_TEXT	ENDS
END
